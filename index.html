<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>about:blank opener — enhanced</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:20px;line-height:1.4}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  input[type=text]{flex:1;padding:8px;border-radius:6px;border:1px solid #ccc}
  button{padding:8px 12px;border-radius:8px;border:1px solid #888;background:#f6f6f6;cursor:pointer}
  textarea{width:100%;height:220px;padding:8px;border-radius:6px;border:1px solid #ccc}
  .box{border:1px dashed #ddd;padding:12px;border-radius:8px;margin-top:12px;background:#fafafa}
  small.note{color:#666;display:block;margin-top:8px}
</style>
</head>
<body>
  <h1>about:blank opener — enhanced</h1>

  <div class="row">
    <input id="msg" type="text" placeholder="Message to pass / initial content" value="Hello from opener!">
    <button id="openWrite">Open & write HTML</button>
    <button id="openQuery">Open with ?msg=</button>
  </div>

  <div class="row">
    <button id="sendMsg" disabled>Send message to child</button>
    <input id="msgToChild" type="text" placeholder="Message for child (postMessage)">
    <button id="broadcast">Broadcast to all children</button>
  </div>

  <div class="box">
    <strong>Child window state:</strong>
    <div id="childrenList">No child windows yet.</div>
    <small class="note">Click buttons to interact. Popups must be allowed by the browser.</small>
  </div>

<script>
(function(){
  // track opened child windows
  const children = new Set();
  const childrenListEl = document.getElementById('childrenList');

  function updateChildrenUI(){
    if(children.size === 0){
      childrenListEl.textContent = 'No child windows yet.';
      document.getElementById('sendMsg').disabled = true;
      return;
    }
    const arr = Array.from(children).filter(w => !w.closed);
    children.clear();
    arr.forEach(w => children.add(w));
    childrenListEl.innerHTML = arr.map((w,i) => `<div>Child ${i+1} — ${w.closed ? 'closed' : 'open'}</div>`).join('');
    document.getElementById('sendMsg').disabled = false;
  }

  // open about:blank and write a rich editor + buttons that can postMessage back to opener
  function openAndWrite(withQuery=false){
    const msg = document.getElementById('msg').value || '';
    const url = withQuery ? ('about:blank?init=' + encodeURIComponent(msg)) : 'about:blank';
    const child = window.open(url, '_blank');
    if(!child){ alert('Popup blocked — allow popups for this site.'); return; }

    // HTML content for child
    const childHtml = `<!doctype html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>about:blank (child)</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <style>
          body{font-family:system-ui;padding:18px}
          textarea{width:100%;height:240px;padding:8px;border-radius:6px;border:1px solid #ccc}
          .row{display:flex;gap:8px;align-items:center;margin-top:8px}
          input{padding:8px;border-radius:6px;border:1px solid #ccc}
          button{padding:8px 10px;border-radius:8px;border:1px solid #888;background:#f6f6f6;cursor:pointer}
        </style>
      </head>
      <body>
        <h2>Editable about:blank</h2>
        <div id="inited" style="margin-bottom:8px;color:#444">Reading initial data…</div>
        <textarea id="editor"></textarea>
        <div class="row">
          <button id="copyBtn">Copy to clipboard</button>
          <button id="downloadBtn">Save as .html</button>
          <input id="toOpener" placeholder="Message to opener">
          <button id="postBtn">Post to opener</button>
        </div>
        <script>
          // populate editor from query string if present (location.search)
          try {
            const params = new URLSearchParams(location.search);
            const init = params.get('init') || '';
            document.getElementById('editor').value = init || 'Editable text here...';
            document.getElementById('inited').textContent = 'Initialized from opener: ' + (init ? init : '(none)');
          } catch(e){}

          // copy to clipboard
          document.getElementById('copyBtn').addEventListener('click', async () => {
            try {
              await navigator.clipboard.writeText(document.getElementById('editor').value);
              alert('Copied to clipboard');
            } catch(e){
              alert('Copy failed: ' + e);
            }
          });

          // download as .html file (export)
          document.getElementById('downloadBtn').addEventListener('click', () => {
            const content = document.getElementById('editor').value;
            const html = '<!doctype html>\\n<html><head><meta charset="utf-8"><title>export</title></head><body>' +
                         content.replace(/</g,'&lt;').replace(/\\n/g,'<br>') +
                         '</body></html>';
            const blob = new Blob([html], {type:'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'export.html';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          });

          // postMessage to opener
          document.getElementById('postBtn').addEventListener('click', () => {
            const txt = document.getElementById('toOpener').value || document.getElementById('editor').value;
            try {
              window.opener && window.opener.postMessage({from:'child', text: txt}, '*');
              alert('Message posted to opener');
            } catch(e){
              alert('Post failed: ' + e);
            }
          });

          // let opener know we're ready
          try {
            window.opener && window.opener.postMessage({from:'child', type:'ready'}, '*');
          } catch(e){}
        <\/script>
      </body>
      </html>`;

    // write to child document
    child.document.open();
    child.document.write(childHtml);
    child.document.close();

    // track child
    children.add(child);
    updateChildrenUI();
  }

  // event listeners for opener controls
  document.getElementById('openWrite').addEventListener('click', () => openAndWrite(false));
  document.getElementById('openQuery').addEventListener('click', () => openAndWrite(true));

  // Send direct message to focused child (first open child)
  document.getElementById('sendMsg').addEventListener('click', () => {
    const txt = document.getElementById('msgToChild').value || '';
    const arr = Array.from(children).filter(w=>!w.closed);
    if(arr.length === 0){ alert('No open child to send to'); return; }
    const target = arr[0];
    try {
      target.postMessage({from:'opener', text: txt}, '*');
      alert('Sent to child');
    } catch(e){ alert('Send failed: '+e); }
  });

  // broadcast to all children
  document.getElementById('broadcast').addEventListener('click', () => {
    const txt = document.getElementById('msgToChild').value || '';
    const arr = Array.from(children).filter(w=>!w.closed);
    if(arr.length === 0){ alert('No open children'); return; }
    arr.forEach(w => {
      try { w.postMessage({from:'opener', text: txt}, '*'); } catch(e){}
    });
    alert('Broadcasted to ' + arr.length + ' child(ren)');
  });

  // listen for messages from children
  window.addEventListener('message', (ev) => {
    try {
      const d = ev.data || {};
      if(d && d.from === 'child'){
        // show in UI
        const el = document.createElement('div');
        el.textContent = 'Child says: ' + (d.text || JSON.stringify(d));
        childrenListEl.appendChild(el);
      }
    } catch(e){}
  });

  // periodically prune closed windows
  setInterval(updateChildrenUI, 2000);
})();
</script>
</body>
</html>
